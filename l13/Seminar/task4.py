# –í—Å–ø–æ–º–∏–Ω–∞–µ–º –∑–∞–¥–∞—á—É –∏–∑ —Å–µ–º–∏–Ω–∞—Ä–∞ 8 –ø—Ä–æ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö,
# –≥–¥–µ –≤ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–º —Ü–∏–∫–ª–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª–∏ –∏–º—è, –ª–∏—á–Ω—ã–π
# –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∏ —É—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞ (–æ—Ç 1 –¥–æ 7) —Å–æ—Ö—Ä–∞–Ω—è—è
# –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ JSON —Ñ–∞–π–ª.
# –ù–∞–ø–∏—à–∏—Ç–µ –∫–ª–∞—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä—ã–π —Ö—Ä–∞–Ω–∏—Ç —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –≤
# —Å–≤–æ–π—Å—Ç–≤–∞—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–∞.
# –û—Ç–¥–µ–ª—å–Ω–æ –Ω–∞–ø–∏—à–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è —Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
# –∏–∑ JSON —Ñ–∞–π–ª–∞ –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.


# –ù–∞–ø–∏—à–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –≤ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–º —Ü–∏–∫–ª–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∏–º—è, –ª–∏—á–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∏ —É—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞ (–æ—Ç l1 –¥–æ l7).
# üìå–ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –≤–≤–æ–¥–∞ –¥–æ–±–∞–≤–ª—è–π—Ç–µ –Ω–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ JSON —Ñ–∞–π–ª.
# üìå–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç—Å—è –ø–æ —É—Ä–æ–≤–Ω—é –¥–æ—Å—Ç—É–ø–∞.
# üìå–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—ã—Å—Ç—É–ø–∞–µ—Ç –∫–ª—é—á—ë–º –¥–ª—è –∏–º–µ–Ω–∏.
# üìå–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã —É–Ω–∏–∫–∞–ª—å–Ω—ã –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —É—Ä–æ–≤–Ω—è –¥–æ—Å—Ç—É–ø–∞.
# üìå–ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ —Ñ—É–Ω–∫—Ü–∏–∏ —É–∂–µ –∑–∞–ø–∏—Å–∞–Ω–Ω—ã–µ –≤ —Ñ–∞–π–ª –¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è.

import json
import os
from l12.Home.task1 import NameValidator
from l12.Home.task1 import UserNameError

PATH_DB = 'user_db.json'


class User:
    name = NameValidator()

    def __init__(self, name: str, uid: int, access_lvl: int):
        self.name = name
        self.uid = uid
        self.access_lvl = access_lvl

    def __eq__(self, other):
        other_uid = None
        if isinstance(other, int):
            other_uid = other
        elif isinstance(other, User):
            other_uid = other.uid
        return self.uid == other_uid

    def __str__(self):
        return f"{self.name}_{self.uid}"

    def __repr__(self):
        return f"{self.name}_{self.uid}"


class UsersDb:
    def __init__(self):
        self.users = []
        if os.path.exists(PATH_DB):
            with open(PATH_DB, 'r', encoding='UTF-8') as file:
                self.temp_json_dump = json.load(file, parse_int=int)
        else:
            self.temp_json_dump = {str(k): {} for k in range(1, 8)}

    def __iter__(self):
        self.current = 0
        return self

    def __next__(self):
        if self.current < len(self.users):
            result = self.users[self.current]
            self.current += 1
            return result
        raise StopIteration

    def __str__(self):
        result = "["
        for user in self:
            result += f"{user.name}_{user.uid}, "
        result += ']'
        return result

    def __repr__(self):
        result = "["
        for user in self:
            result += f"{user.name}_{user.uid}, "
        result += ']'
        return result

    def add_user(self, user: User):
        self.users.append(user)
        selected_lst: dict = self.temp_json_dump[str(user.access_lvl)]
        selected_lst[str(user.uid)] = user.name
        self.__dump_to_json()

    def __create_users_from_json(self, path):
        if os.path.exists(path):
            with open(path, 'r', encoding='UTF-8') as file:
                self.temp_json_dump = json.load(file, parse_int=int)
                for acc_lvl, usr_lst in self.temp_json_dump.items():
                    for uid, name in usr_lst.items():
                        self.add_user(User(name, int(uid), int(acc_lvl)))

    def create_users(self):
        self.__create_users_from_json(PATH_DB)
        while True:
            name = input('–í–≤–µ–¥–∏—Ç–µ –∏–º—è: ')
            if not name:
                self.__dump_to_json()
                break
            lvl = self.input_lvl()
            uid = self.input_id()
            if uid not in self.users:
                try:
                    new_user = User(name, uid, lvl)
                except UserNameError as e:
                    print(e)
                    continue
                self.add_user(new_user)
                self.__dump_to_json()
            else:
                print("–¢–∞–∫–æ–π ID —É–∂–µ –∑–∞–Ω—è—Ç")

    def __dump_to_json(self):
        with open(PATH_DB, 'w', encoding='UTF-8') as file:
            json.dump(self.temp_json_dump, file, indent=4, ensure_ascii=False)

    def input_id(self):
        list_id = (u.uid for u in self.users)
        while True:
            uid = input('–í–≤–µ–¥–∏—Ç–µ ID: ')
            if uid not in list_id and uid.isdigit():
                return uid
            print('–¢–∞–∫–æ–π ID –∑–∞–Ω—è—Ç, –≤–≤–µ–¥–∏—Ç–µ –∑–∞–Ω–æ–≤–æ')

    @staticmethod
    def input_lvl():
        while True:
            lvl = input('–í–≤–µ–¥–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞: ')
            if lvl.isdigit() and 0 < int(lvl) < 8:
                return lvl
            else:
                print("–£—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ 7")


# usr1 = User("Namea", 1, 5)
# usr2 = User("Nameb", 2, 1)
# usr3 = User("Namec", 3, 2)
# usr4 = User("Named", 4, 3)
#
# db_usr = UsersDb()
# db_usr.add_user(usr1)
# db_usr.add_user(usr2)
# db_usr.add_user(usr4)
#
# db_usr.create_users()
